name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    strategy:
      matrix:
        target: [x86_64-pc-windows-msvc, i686-pc-windows-msvc]
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
            artifact_name: ifm-ruta-windows-x64
          - target: i686-pc-windows-msvc
            arch: x86
            artifact_name: ifm-ruta-windows-x86

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-

    - name: Build release binaries
      run: |
        cargo build --release --target ${{ matrix.target }} --workspace

    - name: Create Windows installer directory
      run: |
        mkdir -p dist/windows
        copy target\${{ matrix.target }}\release\ifm-ruta-mcp.exe dist\windows\
        copy target\${{ matrix.target }}\release\ifm-ruta-egui.exe dist\windows\

    - name: Create Windows ZIP archive
      run: |
        cd dist/windows
        Compress-Archive -Path * -DestinationPath ..\${{ matrix.artifact_name }}.zip

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}.zip

  build-fedora:
    name: Build Fedora RPM
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64-unknown-linux-gnu, i686-unknown-linux-gnu]
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x86_64
            rpm_name: ifm-ruta-x86_64
          - target: i686-unknown-linux-gnu
            arch: i686
            rpm_name: ifm-ruta-i686

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        target: ${{ matrix.target }}

    - name: Install RPM build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y rpm

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Build release binaries
      run: |
        cargo build --release --target ${{ matrix.target }} --workspace

    - name: Create RPM spec file
      run: |
        cat > ifm-ruta.spec << 'EOF'
        Name:           ifm-ruta
        Version:        ${{ github.event.inputs.version || github.ref_name }}
        Release:        1%{?dist}
        Summary:        Interactive Feedback MCP - Rust + egui
        License:        MIT
        URL:            https://github.com/ismhac/ifm-ruta
        Source0:        %{name}-%{version}.tar.gz
        
        BuildArch:      ${{ matrix.arch }}
        BuildRequires:  systemd-rpm-macros
        
        %description
        A high-performance, cross-platform MCP (Model Context Protocol) server 
        for interactive feedback in AI-assisted development, built with Rust and egui.
        
        %prep
        %setup -q
        
        %build
        # Binaries are pre-built
        
        %install
        rm -rf $RPM_BUILD_ROOT
        mkdir -p $RPM_BUILD_ROOT/usr/bin
        mkdir -p $RPM_BUILD_ROOT/usr/share/doc/ifm-ruta
        mkdir -p $RPM_BUILD_ROOT/usr/share/licenses/ifm-ruta
        
        # Install binaries
        install -m 755 target/${{ matrix.target }}/release/ifm-ruta-mcp $RPM_BUILD_ROOT/usr/bin/
        install -m 755 target/${{ matrix.target }}/release/ifm-ruta-egui $RPM_BUILD_ROOT/usr/bin/
        
        # Install documentation
        install -m 644 README.md $RPM_BUILD_ROOT/usr/share/doc/ifm-ruta/
        install -m 644 LICENSE $RPM_BUILD_ROOT/usr/share/licenses/ifm-ruta/
        
        %files
        %defattr(-,root,root,-)
        /usr/bin/ifm-ruta-mcp
        /usr/bin/ifm-ruta-egui
        %doc /usr/share/doc/ifm-ruta/README.md
        %license /usr/share/licenses/ifm-ruta/LICENSE
        
        %changelog
        * $(date '+%a %b %d %Y') IFM-Ruta Team <team@ifm-ruta.dev> - ${{ github.event.inputs.version || github.ref_name }}-1
        - Initial release
        EOF

    - name: Create source tarball
      run: |
        tar -czf ifm-ruta-${{ github.event.inputs.version || github.ref_name }}.tar.gz \
          --exclude='.git' \
          --exclude='target' \
          --exclude='.github' \
          --exclude='*.rpm' \
          .

    - name: Build RPM package
      run: |
        rpmbuild -bb ifm-ruta.spec \
          --define "_sourcedir $(pwd)" \
          --define "_rpmdir $(pwd)/dist" \
          --define "_builddir $(pwd)" \
          --define "_specdir $(pwd)" \
          --define "_srcrpmdir $(pwd)/dist"

    - name: Upload Fedora artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.rpm_name }}
        path: dist/*.rpm

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-fedora]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Create release archive
      run: |
        mkdir -p release
        # Copy Windows artifacts
        find . -name "ifm-ruta-windows-*.zip" -exec cp {} release/ \;
        # Copy Fedora artifacts
        find . -name "ifm-ruta-*.rpm" -exec cp {} release/ \;
        
        # Create combined archive
        cd release
        tar -czf ../ifm-ruta-${{ github.ref_name }}-all.tar.gz *

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/ifm-ruta-windows-x64.zip
          release/ifm-ruta-windows-x86.zip
          release/ifm-ruta-x86_64.rpm
          release/ifm-ruta-i686.rpm
          ifm-ruta-${{ github.ref_name }}-all.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-artifacts:
    name: Test Release Artifacts
    runs-on: ubuntu-latest
    needs: [build-windows, build-fedora]
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Download Windows artifacts
      uses: actions/download-artifact@v3
      with:
        name: ifm-ruta-windows-x64

    - name: Download Fedora artifacts
      uses: actions/download-artifact@v3
      with:
        name: ifm-ruta-x86_64

    - name: Test Windows ZIP
      run: |
        unzip -t ifm-ruta-windows-x64.zip
        echo "Windows ZIP is valid"

    - name: Test Fedora RPM
      run: |
        rpm -qp --info ifm-ruta-*.rpm
        echo "Fedora RPM is valid"
